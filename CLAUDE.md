# RP6502 Picocomputer Emulator

## Project Goal

Build a Rust-based "digital twin" emulator for the RP6502 Picocomputer. The emulator models the RIA (Retro Interface Adapter) and VGA components as independent threads communicating via typed PIX messages, mirroring the real hardware topology. Uses egui to display the framebuffer.

Eventually a 6502 CPU emulator will be added. For now, bus traces (generated by a test harness) drive the system.

## Architecture

```
[Bus Trace] -> [RIA Thread] -> PIX Channel -> [VGA Thread] -> [Framebuffer]
                                                                    |
                                                              [egui Renderer]
                    Backchannel Channel <---------------------------|
```

- **RIA thread**: Replays bus traces, owns the 32-byte register file ($FFE0-$FFFF), 64KB XRAM, and XSTACK. Emits PIX messages over a crossbeam channel. Master clock â€” sends FrameSync every phi2_freq/60 cycles.
- **VGA thread**: Receives PIX messages, maintains its own XRAM replica, renders Mode 3 bitmap into an RGBA framebuffer. Sends VSYNC/ACK/NAK backchannel messages.
- **egui main thread**: Displays framebuffer as a texture.

## Key Reference Files (firmware source)

- `firmware/src/ria/sys/ria.c` - RIA action loop (register read/write behavior, lines 245-407 are critical)
- `firmware/src/ria/sys/ria.h` - RIA pin definitions, register addresses
- `firmware/src/ria/sys/pix.h` - PIX protocol definitions and PIX_MESSAGE macro
- `firmware/src/ria/sys/mem.h` - XRAM, XSTACK, register file memory layout
- `firmware/src/ria/api/api.h` - API fastcall registers, return mechanism, xstack helpers
- `firmware/src/ria/api/api.c` - Reset defaults, errno mapping, OS operation dispatch
- `firmware/src/vga/sys/pix.c` - VGA PIX receiver (register and XRAM paths)
- `firmware/src/vga/modes/mode3.c` - Mode 3 bitmap renderer
- `firmware/src/vga/sys/ria.c` - VGA backchannel (VSYNC, ACK, NAK)
- `firmware/src/vga/term/color.c` - Built-in palettes
- `pico-docs/docs/source/ria.rst` - Register documentation
- `pico-docs/docs/source/vga.rst` - VGA mode documentation

## Design Doc

Full design at `docs/plans/2026-02-21-emulator-design.md`. Covers register behavior, PIX protocol, VGA Mode 3 rendering, threading model, and project structure.

## MVP Scope

- Mode 3 (Bitmap) rendering only, 640x480 canvas
- All 5 color depths (1/2/4/8/16 bpp)
- Bus trace replay (binary + text formats)
- Test harness for generating traces
- OS operations: zxstack (0x00), xreg (0x01), exit (0xFF); others return ENOSYS

## Tech Stack

- Rust
- `eframe` / `egui` for windowed framebuffer display
- `crossbeam-channel` for PIX bus and backchannel
- `bytemuck` for zero-copy framebuffer casting
