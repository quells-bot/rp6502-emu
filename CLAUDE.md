# RP6502 Picocomputer Emulator

## Project Goal

Build a Rust-based "digital twin" emulator for the RP6502 Picocomputer. The emulator models the RIA (Retro Interface Adapter) and VGA components as independent threads communicating via typed PIX messages, mirroring the real hardware topology. Uses egui to display the framebuffer.

Eventually a 6502 CPU emulator will be added. For now, bus traces (generated by a test harness) drive the system.

## Architecture

```
[Bus Trace] -> [RIA Thread] -> PIX Channel -> [VGA Thread] -> [Framebuffer]
                                                                    |
                                                              [egui Renderer]
                    Backchannel Channel <---------------------------|
```

- **RIA thread**: Replays bus traces, owns the 32-byte register file ($FFE0-$FFFF), 64KB XRAM, and XSTACK. Emits PIX messages over a crossbeam channel. Master clock — sends FrameSync every phi2_freq/60 cycles.
- **VGA thread**: Receives PIX messages, maintains its own XRAM replica, renders Mode 1 (character) and Mode 3 (bitmap) into an RGBA framebuffer. Sends VSYNC/ACK/NAK backchannel messages.
- **egui main thread**: Displays framebuffer as a texture.

## Submodules

| Submodule | Description |
|-----------|-------------|
| `firmware/` | RP6502 firmware (RIA + VGA Pico source) — the reference implementation |
| `cc65/` | cc65 toolchain fork with RP6502 target support |
| `pico-examples/` | Official RP6502 example programs (C, built with cc65) |
| `pico-docs/` | RP6502 documentation (register specs, VGA mode docs) |

## Key Reference Files

### Firmware source (the "ground truth")

- `firmware/src/ria/sys/ria.c` - RIA action loop (register read/write behavior, lines 245-407 are critical)
- `firmware/src/ria/sys/ria.h` - RIA pin definitions, register addresses
- `firmware/src/ria/sys/pix.h` - PIX protocol definitions and PIX_MESSAGE macro
- `firmware/src/ria/sys/mem.h` - XRAM, XSTACK, register file memory layout
- `firmware/src/ria/api/api.h` - API fastcall registers, return mechanism, xstack helpers
- `firmware/src/ria/api/api.c` - Reset defaults, errno mapping, OS operation dispatch
- `firmware/src/vga/sys/pix.c` - VGA PIX receiver (register and XRAM paths)
- `firmware/src/vga/modes/mode1.c` - Mode 1 character renderer
- `firmware/src/vga/modes/mode3.c` - Mode 3 bitmap renderer
- `firmware/src/vga/sys/ria.c` - VGA backchannel (VSYNC, ACK, NAK)
- `firmware/src/vga/term/color.c` - Built-in palettes

### cc65 header (C API for user programs)

- `cc65/include/rp6502.h` - Struct definitions (`vga_mode1_config_t`, `vga_mode3_config_t`), xreg constants, register addresses. The emulator's `ria_api.rs` mirrors these struct layouts.

### pico-examples (validation targets)

- `pico-examples/src/mandelbrot.c` - Mandelbrot renderer (4bpp Mode 3); our `mandelbrot` test mode replicates this pixel-for-pixel
- `pico-examples/src/mode1.c` - Mode 1 character demo
- `pico-examples/src/mode3.c` - Mode 3 bitmap demo
- `pico-examples/src/mode2.c` - Mode 2 (tile) demo (not yet implemented)

### Documentation

- `pico-docs/docs/source/ria.rst` - Register documentation
- `pico-docs/docs/source/vga.rst` - VGA mode documentation

## Design Doc

Full design at `docs/plans/2026-02-21-emulator-design.md`. Covers register behavior, PIX protocol, VGA Mode 3 rendering, threading model, and project structure.

## Current Scope

- **Mode 1** (Character): CP437 font, 10 attribute modes (1bpp–4bpp, 8×8 and 8×16 cells)
- **Mode 2** (Tile): 8x8 and 16×16 tile sizes, 4 color depths (1/2/4/8 bpp), scrolling and wrapping
- **Mode 3** (Bitmap): all 5 color depths (1/2/4/8/16 bpp), multiple canvas sizes
- Bus trace replay (binary + text formats)
- **TraceBuilder** (`ria_api.rs`): high-level helpers that generate bus traces matching cc65 API calls (`xreg`, `xram0_write`, `xram0_struct_set`, `op_exit`, `wait_frames`, etc.)
- **Mandelbrot test mode**: pixel-for-pixel match of `pico-examples/src/mandelbrot.c`
- OS operations: zxstack (0x00), xreg (0x01), exit (0xFF); others return ENOSYS

## Tech Stack

- Rust
- `eframe` / `egui` for windowed framebuffer display
- `crossbeam-channel` for PIX bus and backchannel
- `bytemuck` for zero-copy framebuffer casting
- `clap` for CLI argument parsing
- `png` for headless screenshot export

## Emulator Source (`emu/`)

The MVP emulator is implemented in `emu/`. Run with `cargo run` from that directory.

### Module layout

| File | Description |
|------|-------------|
| `src/bus.rs` | `BusTransaction` — single 6502 bus cycle |
| `src/pix.rs` | PIX protocol types and pack/unpack helpers |
| `src/ria.rs` | RIA state machine: register file, XRAM portals, XSTACK, PIX emission |
| `src/ria_api.rs` | `TraceBuilder` — high-level helpers that emit bus traces matching cc65 API calls; struct offset constants mirroring `cc65/include/rp6502.h` |
| `src/vga/palette.rs` | Built-in palettes: 2-color (1bpp) and ANSI 256-color; palette resolution shared across modes |
| `src/vga/font.rs` | Built-in CP437 8×16 font data for Mode 1 |
| `src/vga/mode1.rs` | Mode 1 (Character) renderer — 10 attribute modes, 8×8/8×16 cells |
| `src/vga/mode3.rs` | Mode 3 (Bitmap) renderer — all color depths |
| `src/vga/mod.rs` | VGA state machine: PIX receiver, frame renderer, backchannel |
| `src/test_harness.rs` | `generate_test_trace(TestMode)` — test patterns including Mandelbrot (pixel-for-pixel match of pico-examples) |
| `src/screenshot.rs` | PNG encoding for headless framebuffer export |
| `src/main.rs` | CLI (clap), wires threads: RIA + VGA + egui or headless screenshot |

### CLI usage

```
cargo run                                              # launch egui window (default)
cargo run -- screenshot --mode mono320x240 -o out.png  # headless screenshot
```

Valid `--mode` values: `mono640x480`, `mono640x360`, `mono320x240`, `mono320x180`, `color2bpp640x360`, `color2bpp320x240`, `color2bpp320x180`, `color4bpp320x240`, `color4bpp320x180`, `color8bpp320x180`, `color16bpp320`, `mandelbrot`, `mode1_1bpp_8x8`, `mode1_1bpp_8x16`, `mode1_2bpp_8x8`, `mode1_2bpp_8x16`, `mode1_4bpp_8x8`, `mode1_4bpp_8x16`, `mode1_4bpr_8x8`, `mode1_4bpr_8x16`, `mode1_fg_8x8`, `mode1_fg_8x16`, `tile1bpp8x8`, `tile1bpp16x16`.

### Shared framebuffer type

`Arc<Mutex<Vec<u8>>>` — always 640×480 RGBA bytes (614,400 bytes). Written by VGA thread on every FrameSync; read by egui each repaint. Dimensions are fixed so no size field is needed.

### Key implementation notes

- **xreg byte order**: push hi byte first so lo byte lands at lower XRAM address, matching `from_le_bytes` in `handle_xreg`.
- **PICO_SCANVIDEO pixel format**: R5 at bits 4:0, alpha at bit 5, G5 at bits 10:6, B5 at bits 15:11 (not standard RGB565).
- **xreg register mapping**: first-pushed data → lowest register; `handle_xreg` iterates `for i in 0..count` with `offset = xstack_ptr + (count-1-i)*2`.
- **Pixel doubling**: 320-wide canvases are 2x pixel-doubled by the VGA thread (each pixel written twice horizontally) to fill the 640×480 display framebuffer.
